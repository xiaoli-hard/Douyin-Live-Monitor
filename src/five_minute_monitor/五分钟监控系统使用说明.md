# 五分钟话术监控系统使用说明

## 系统概述

五分钟话术监控系统是一个实时监控直播话术内容的工具，能够每5分钟自动检查最近5分钟内的话术内容，识别和警报闲聊行为。

## 主要功能

### 1. 实时数据监控
- 自动读取 `text` 目录下的实时话术JSON文件
- 基于精确时间戳筛选指定时间窗口内的数据
- 支持跨小时数据读取

### 2. 双重检测机制
- **关键词检测**: 基于预定义的闲聊关键词库进行快速匹配
- **AI智能分析**: 使用豆包AI进行深度语义分析

### 3. 智能警报系统
- **normal**: 正常状态，闲聊比例 < 10%
- **medium**: 中等警报，闲聊比例 10%-30%
- **high**: 高级警报，闲聊比例 > 30%

### 4. 详细报告生成
- 实时监控日志
- 异常情况详细报告
- JSON格式结构化数据

### 5. 钉钉机器人通知
- 自动发送监控结果到钉钉群
- 支持不同警报级别的消息样式
- 可配置发送策略（全部发送或仅异常发送）

## 文件说明

### 核心文件
- `five_minute_monitor.py`: 核心监控脚本
- `start_five_minute_monitor.py`: 用户友好的启动界面
- `test_dingtalk.py`: 钉钉机器人功能测试脚本
- `五分钟监控系统使用说明.md`: 本说明文档

### 配置文件
- `src/host_script_acquisition/config.json`: AI API配置

### 数据文件
- `text/transcripts_JSON_实时_*.json`: 实时话术数据
- `text/transcripts_DB_实时_*.db`: 实时话术数据库

### 输出文件
- `five_minute_monitor.log`: 监控运行日志
- `five_minute_monitor_YYYYMMDD_HHMMSS.json`: 异常报告

## 使用方法

### 方法一：使用启动界面（推荐）

```bash
python start_five_minute_monitor.py
```

启动后会显示菜单：
1. 单次监控 - 检查最近5分钟的话术内容
2. 连续监控 - 每5分钟自动检查一次
3. 自定义间隔连续监控
4. 查看帮助
5. 退出

### 方法二：直接运行监控脚本

**单次监控**:
```bash
python five_minute_monitor.py
```

**连续监控**:
```bash
python five_minute_monitor.py --continuous
```

### 方法三：测试钉钉机器人功能

**测试钉钉消息发送**:
```bash
python test_dingtalk.py
```

此脚本会发送三种不同级别的测试消息到钉钉群：
- 正常状态消息
- 中等警报消息  
- 高级警报消息

用于验证钉钉机器人配置是否正确。

## 监控原理

### 数据获取流程
1. 扫描 `text` 目录下的最新实时话术文件
2. 解析JSON格式的话术数据
3. 根据时间戳筛选最近5分钟内的记录
4. 按时间顺序排列话术内容

### 闲聊检测算法

#### 关键词检测
预定义闲聊关键词库包括：
- 语气词："哈哈"、"呵呵"、"嘻嘻"、"哎呀"
- 日常话题："天气"、"旅游"、"电影"、"音乐"
- 闲聊标识："聊天"、"八卦"、"随便聊聊"
- 话题转换："话说"、"对了"、"题外话"

#### AI智能分析
使用豆包AI进行语义分析，识别：
- 与产品销售无关的个人话题
- 天气、日常生活等话题
- 与观众的非业务性互动
- 偏离主题的随意聊天

### 警报机制
- 计算关键词检测和AI分析的闲聊比例
- 根据比例阈值确定警报级别
- 异常情况自动生成详细报告

## 配置说明

### AI API配置
确保 `src/host_script_acquisition/config.json` 中包含正确的豆包API配置：

```json
{
  "douban_api": {
    "api_key": "your-api-key",
    "model_name": "doubao-seed-1-6-250615",
    "endpoint": "https://ark.cn-beijing.volces.com/api/v3"
  }
}
```

### 钉钉机器人配置
在 `five_minute_monitor.py` 中配置钉钉机器人参数：

```python
# 钉钉机器人配置
self.dingtalk_webhook = "https://oapi.dingtalk.com/robot/send?access_token=YOUR_ACCESS_TOKEN"
self.dingtalk_secret = "YOUR_SECRET_KEY"
self.dingtalk_send_all = True  # True: 所有监控结果都发送, False: 只发送异常警报
```

**配置步骤：**
1. 在钉钉群中添加自定义机器人
2. 选择"加签"安全设置
3. 复制webhook地址和密钥
4. 将webhook地址和密钥填入配置中

**发送策略配置：**
- `dingtalk_send_all = True`: 每次监控都发送消息（包括正常状态）
- `dingtalk_send_all = False`: 仅在检测到异常时发送消息

### 监控参数调整
可以在 `five_minute_monitor.py` 中调整：
- 监控时间窗口（默认5分钟）
- 闲聊关键词库
- 警报阈值

## 输出示例

### 控制台输出
```
2025-09-05 11:14:31,290 - INFO - 开始执行五分钟话术监控...
2025-09-05 11:14:31,295 - INFO - 获取到 99 条最近5分钟的话术记录
2025-09-05 11:14:49,471 - INFO - 监控结果 - 警报级别: normal
2025-09-05 11:14:49,471 - INFO - 关键词检测到闲聊: 2 条
2025-09-05 11:14:49,471 - INFO - AI分析闲聊比例: 2.00%
2025-09-05 11:14:50,123 - INFO - 钉钉消息发送成功
2025-09-05 11:14:50,124 - INFO - 正常监控状态已通知到钉钉
```

### 钉钉消息示例

**正常状态消息：**
```
✅ 正常监控 - 主播话术监控

监控时间： 2025-09-05 11:14:49
监控窗口： 最近5分钟
话术总数： 99 条
关键词检测： 2 条闲聊
AI分析比例： 2.00%
警报级别： NORMAL

💡 提示： 如需查看详细分析，请检查监控日志文件
```

**高级警报消息：**
```
🚨 高级警报 - 主播话术监控

监控时间： 2025-09-05 11:20:15
监控窗口： 最近5分钟
话术总数： 30 条
关键词检测： 15 条闲聊
AI分析比例： 50.00%
警报级别： HIGH

💡 提示： 如需查看详细分析，请检查监控日志文件
```

### JSON报告格式
```json
{
  "monitor_time": "2025-09-05 11:14:49",
  "time_window": "最近5分钟",
  "total_transcripts": 99,
  "keyword_detection": {
    "chat_count": 2,
    "instances": [
      {
        "timestamp": "2025-09-05 11:12:32",
        "text": "闲聊内容示例",
        "keyword": "匹配的关键词",
        "type": "keyword_match"
      }
    ]
  },
  "ai_analysis": {
    "has_chat": true,
    "chat_ratio": 0.02,
    "chat_instances": [],
    "summary": "AI分析总结"
  },
  "alert_level": "normal"
}
```

## 故障排除

### 常见问题

1. **找不到话术数据文件**
   - 检查 `text` 目录是否存在
   - 确认实时数据采集系统正在运行

2. **AI API调用失败**
   - 检查网络连接
   - 验证API密钥是否正确
   - 确认API配额是否充足

3. **时间戳解析错误**
   - 检查JSON文件格式是否正确
   - 确认时间戳格式为 "YYYY-MM-DD HH:MM:SS"

4. **钉钉消息发送失败**
   - 检查webhook地址是否正确
   - 验证加签密钥是否匹配
   - 确认网络连接正常
   - 检查钉钉机器人是否被禁用
   - 运行 `python test_dingtalk.py` 进行测试

### 日志查看
查看 `five_minute_monitor.log` 文件获取详细的运行日志和错误信息。

## 性能优化

### 建议配置
- 监控间隔：5分钟（平衡实时性和性能）
- 数据窗口：5分钟（避免数据量过大）
- 文件缓存：保留最近2个小时的文件

### 资源使用
- 内存使用：约50-100MB
- CPU使用：监控时短暂占用，平时几乎为0
- 网络使用：仅AI API调用时使用

## 扩展功能

### 自定义关键词
可以在 `FiveMinuteMonitor` 类的 `chat_keywords` 列表中添加自定义关键词。

### 集成其他AI服务
可以修改 `_init_openai_client` 方法来支持其他AI服务提供商。

### 数据库存储
可以扩展系统将监控结果存储到数据库中，便于历史数据分析。

## 更新日志

### v1.1.0 (2025-09-05)
- 新增钉钉机器人通知功能
- 支持自动发送监控结果到钉钉群
- 添加不同警报级别的消息样式
- 提供可配置的发送策略
- 新增钉钉功能测试脚本
- 完善使用说明文档

### v1.0.0 (2025-09-05)
- 初始版本发布
- 支持五分钟实时监控
- 关键词和AI双重检测
- 智能警报系统
- 详细报告生成

---

如有问题或建议，请查看日志文件或联系技术支持。