# 五分钟监控系统 - 钉钉机器人集成

## 功能概述

本次更新为五分钟话术监控系统集成了钉钉机器人通知功能，能够自动将监控结果发送到钉钉群，实现实时警报和状态通知。

## 新增功能

### 🤖 钉钉机器人通知
- **自动消息发送**: 监控完成后自动发送结果到钉钉群
- **多级别警报**: 支持正常、中等、高级三种警报级别的不同消息样式
- **安全认证**: 使用钉钉加签方式确保消息安全
- **灵活配置**: 可选择发送所有监控结果或仅发送异常警报

### 📊 消息内容
每条钉钉消息包含以下信息：
- 监控时间和时间窗口
- 话术总数统计
- 关键词检测结果
- AI分析闲聊比例
- 警报级别状态

## 快速开始

### 1. 配置钉钉机器人

在钉钉群中添加自定义机器人：
1. 打开钉钉群 → 群设置 → 智能群助手 → 添加机器人
2. 选择"自定义"机器人
3. 设置机器人名称（如：话术监控助手）
4. 安全设置选择"加签"
5. 复制生成的Webhook地址和密钥

### 2. 修改配置

编辑 `five_minute_monitor.py` 文件，找到钉钉配置部分：

```python
# 钉钉机器人配置
self.dingtalk_webhook = "你的webhook地址"
self.dingtalk_secret = "你的加签密钥"
self.dingtalk_send_all = True  # True: 所有结果都发送, False: 仅异常发送
```

### 3. 验证配置

运行配置验证脚本：
```bash
python verify_dingtalk_config.py
```

### 4. 测试功能

运行测试脚本发送测试消息：
```bash
python test_dingtalk.py
```

### 5. 开始监控

启动监控系统：
```bash
# 单次监控
python five_minute_monitor.py

# 连续监控
python five_minute_monitor.py --continuous

# 或使用启动界面
python start_five_minute_monitor.py
```

## 文件说明

### 新增文件
- `verify_dingtalk_config.py`: 配置验证脚本
- `test_dingtalk.py`: 功能测试脚本
- `README_钉钉集成.md`: 本说明文档

### 修改文件
- `five_minute_monitor.py`: 添加钉钉机器人功能
- `五分钟监控系统使用说明.md`: 更新完整使用说明

## 消息示例

### 正常状态
```
✅ 正常监控 - 主播话术监控

监控时间： 2025-09-05 14:30:15
监控窗口： 最近5分钟
话术总数： 85 条
关键词检测： 3 条闲聊
AI分析比例： 3.53%
警报级别： NORMAL

💡 提示： 如需查看详细分析，请检查监控日志文件
```

### 高级警报
```
🚨 高级警报 - 主播话术监控

监控时间： 2025-09-05 14:35:20
监控窗口： 最近5分钟
话术总数： 40 条
关键词检测： 18 条闲聊
AI分析比例： 45.00%
警报级别： HIGH

💡 提示： 如需查看详细分析，请检查监控日志文件
```

## 配置选项

### 发送策略
- `dingtalk_send_all = True`: 每次监控都发送消息（推荐用于测试）
- `dingtalk_send_all = False`: 仅在检测到异常时发送（推荐用于生产）

### 警报级别阈值
- **normal**: 闲聊比例 < 10%
- **medium**: 闲聊比例 10%-30%
- **high**: 闲聊比例 > 30%

## 故障排除

### 常见问题

1. **消息发送失败**
   - 检查webhook地址是否正确
   - 验证加签密钥是否匹配
   - 确认网络连接正常
   - 运行 `verify_dingtalk_config.py` 检查配置

2. **签名验证失败**
   - 确认使用的是"加签"安全设置
   - 检查密钥是否完整复制
   - 确认时间同步正常

3. **机器人被禁用**
   - 检查钉钉群中机器人状态
   - 确认机器人权限设置
   - 联系群管理员检查设置

### 调试步骤

1. 运行配置验证: `python verify_dingtalk_config.py`
2. 发送测试消息: `python test_dingtalk.py`
3. 查看详细日志: `five_minute_monitor.log`
4. 检查网络连接和防火墙设置

## 技术实现

### 安全机制
- 使用HMAC-SHA256算法生成签名
- 时间戳防重放攻击
- URL编码确保传输安全

### 消息格式
- 使用Markdown格式美化消息
- 支持emoji图标增强可读性
- 结构化信息便于快速理解

### 错误处理
- 网络超时重试机制
- 详细错误日志记录
- 优雅降级处理

## 更新历史

### v1.1.0 (2025-09-05)
- ✨ 新增钉钉机器人通知功能
- 🎨 支持多级别警报消息样式
- ⚙️ 提供灵活的发送策略配置
- 🧪 添加配置验证和功能测试脚本
- 📚 完善文档和使用说明

---

## 联系支持

如遇问题或需要帮助，请：
1. 查看 `five_minute_monitor.log` 日志文件
2. 运行 `verify_dingtalk_config.py` 检查配置
3. 参考 `五分钟监控系统使用说明.md` 完整文档

🎉 **恭喜！** 您已成功集成钉钉机器人通知功能，现在可以实时接收话术监控警报了！